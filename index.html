<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>谁动了我的煎饼？</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#ef4444
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,"PingFang SC",Segoe UI,Roboto
}

#start{
  position:fixed;
  inset:0;
  display:grid;
  place-items:center;
  background:var(--bg);
  z-index:10
}

#startBtn{
  font-size:40px;
  font-weight:800;
  padding:18px 64px;
  border:0;
  border-radius:18px;
  background:var(--accent);
  color:#fff;
  cursor:pointer
}

.wrap{
  min-height:100vh;
  display:grid;
  grid-template-rows:auto 1fr;
  gap:14px;
  place-items:center;
  padding:20px;
  position:relative
}

#titlebar{
  font-size:28px;
  font-weight:800;
  letter-spacing:.5px;
  text-align:center;
  margin-top:10px
}

.btn{
  border:1px solid #334155;
  background:#1f2937;
  color:#e5e7eb;
  border-radius:10px;
  padding:6px 12px;
  cursor:pointer
}

#save{
  position:absolute;
  top:16px;
  right:24px
}

#stage{
  position:relative;
  width:min(1400px,94vw);
  height:calc(88vh - 120px);
  display:flex;
  align-items:center;
  justify-content:center
}

#chart{
  width:100%;
  height:100%;
  background:var(--card);
  border:1px solid #334155;
  border-radius:16px
}

/* 派送方下拉 */
#selector{
  position:absolute;
  top:26px;
  left:34px;
  z-index:2;
  border:1px solid #334155;
  background:#1f2937;
  color:#e5e7eb;
  border-radius:12px;
  padding:8px 14px;
}

/* ✅ 自适应状态文本框（右上角） */
#statusBox{
  position:absolute;
  right:34px;
  top:78px;
  z-index:2;

  width:320px;
  height:auto;
  padding:14px 16px;

  background:#0b1222;
  border:1px solid #334155;
  border-radius:14px;

  color:#e5e7eb;
  font-size:16px;
  line-height:1.7;

  white-space:pre-line;
  box-shadow:0 0 0 2px rgba(255,255,255,0.03) inset;

  max-height:260px;
  overflow:auto;
  display:none;
}

#statusBox::-webkit-scrollbar{width:10px}
#statusBox::-webkit-scrollbar-thumb{
  background:#24324a;
  border-radius:10px;
  border:2px solid #0b1222
}

.sr-only{
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0
}
</style>
</head>

<body>

<section id="start">
  <button id="startBtn">START</button>
</section>

<main class="wrap" id="main" style="display:none">
  <div id="titlebar"></div>
  <button id="save" class="btn" disabled>下载 PNG</button>

  <div id="stage">
    <select id="selector"></select>
    <div id="statusBox"></div>
    <div id="chart"></div>
  </div>
</main>

<input type="file" id="file" accept=".xlsx" class="sr-only"/>

<script>
const start = document.getElementById('start');
const startBtn = document.getElementById('startBtn');
const main = document.getElementById('main');
const fileEl = document.getElementById('file');
const save = document.getElementById('save');
const selector = document.getElementById('selector');
const titlebar = document.getElementById('titlebar');
const statusBox = document.getElementById('statusBox');

let chart;

const norm = s => String(s ?? '')
  .replace(/[\s\u00A0\u200B-\u200D\uFEFF]/g,'')
  .toLowerCase();

const fmt = n => n.toLocaleString('en-US');

let GROUP = new Map();

startBtn.onclick = ()=>{ fileEl.value=''; fileEl.click(); };
selector.onchange = ()=> renderByGroup(selector.value);

fileEl.addEventListener('change', async e=>{
  const f = e.target.files?.[0];
  if(!f) return;
  await loadWorkbook(f);
  start.style.display='none';
  main.style.display='grid';
  initChart();
});

function initChart(){
  if(chart) return;
  chart = echarts.init(document.getElementById('chart'));
  window.addEventListener('resize',()=>chart.resize());
}

async function loadWorkbook(file){
  GROUP.clear();
  const wb = XLSX.read(await file.arrayBuffer(),{type:'array'});

  for(const name of wb.SheetNames){
    const s = wb.Sheets[name];
    if(!s?.['!ref']) continue;
    const rows = XLSX.utils.sheet_to_json(s,{defval:''});
    for(const r of rows){
      if(!r['派送方'] || !r['运单状态']) continue;
      if(!GROUP.has(r['派送方'])) GROUP.set(r['派送方'],new Map());
      const m = GROUP.get(r['派送方']);
      m.set(r['运单状态'],(m.get(r['运单状态'])||0)+1);
    }
  }

  const keys = [...GROUP.keys()].sort();
  selector.innerHTML = keys.map(k=>`<option value="${k}">${k}</option>`).join('');
  renderByGroup(keys[0]);
  save.disabled=false;
}

function updateTitle(group,map){
  const total=[...map.values()].reduce((a,b)=>a+b,0);
  const PICK=new Set(['快递员收件','签收','派送异常'].map(norm));
  let pick=0;
  for(const [k,v] of map) if(PICK.has(norm(k))) pick+=v;
  const rate=total?pick/total:0;
  const suf=group.split('-').pop();
  titlebar.textContent =
    `${group} · 实际取件量 ${fmt(pick)} ｜ 应派件量 ${fmt(total)} ｜ ${suf}取件率 ${(rate*100).toFixed(2)}%`;
}

function updateStatusBox(map){
  const IGNORE=new Set(['快递员收件','签收','派送异常'].map(norm));
  const CLASS=new Set(['退回站点','集包','退回转运中心','上架','站点签入'].map(norm));

  const get=n=>[...map].find(([k])=>norm(k)===norm(n))?.[1]||0;

  const lines=[];
  const dsp=get('退回站点')+get('集包')+get('退回转运中心');
  const out=get('上架');
  const nr=get('站点签入');

  if(dsp>0) lines.push(`DSP错分${fmt(dsp)}`);
  if(out>0) lines.push(`外城错分${fmt(out)}`);
  if(nr>0)  lines.push(`未收到${fmt(nr)}`);

  for(const [k,v] of map){
    const n=norm(k);
    if(v<=0||IGNORE.has(n)||CLASS.has(n)) continue;
    lines.push(`${k}${fmt(v)}`);
  }

  statusBox.textContent = lines.join('\n');
  statusBox.style.display = lines.length ? 'block' : 'none';
}

function renderByGroup(key){
  const map=GROUP.get(key);
  updateTitle(key,map);
  updateStatusBox(map);

  chart.setOption({
    tooltip:{trigger:'item',formatter:p=>`${p.name} ${fmt(p.value)}｜${p.percent}%`},
    legend:{type:'scroll',orient:'vertical',left:'4%',top:'center'},
    series:[{
      type:'pie',
      radius:['52%','86%'],
      center:['60%','52%'],
      itemStyle:{borderColor:'#0f172a',borderWidth:2},
      label:{formatter:p=>`${p.name} ${p.percent}%`},
      data:[...map].map(([n,v])=>({name:n,value:v}))
    }]
  },true);
}

save.onclick=()=>{
  const url=chart.getDataURL({type:'png',pixelRatio:2,backgroundColor:'#0f172a'});
  const a=document.createElement('a');
  a.href=url;
  a.download=`${selector.value}.png`;
  a.click();
};
</script>

</body>
</html>
