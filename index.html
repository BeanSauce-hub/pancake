<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>谁动了我的煎饼？</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    :root{ --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#ef4444; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC",sans-serif;color:var(--text)}
    /* 开始页：只让按钮居中 */
    #startScreen{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1000px 400px at 50% -10%, #172036, transparent), var(--bg);z-index:10;}
    #brand{position:absolute;top:28px;left:28px;font-weight:700;letter-spacing:.5px;opacity:.9}
    #startBtn{
      font-size:44px;font-weight:800;letter-spacing:2px;padding:22px 70px;border:none;border-radius:22px;cursor:pointer;
      color:#fff;background:var(--accent);box-shadow:0 12px 40px rgba(239,68,68,.35);transition:transform .12s, box-shadow .12s, background .12s;
    }
    #startBtn:hover{transform:translateY(-1px);background:#dc2626;box-shadow:0 14px 50px rgba(239,68,68,.5)}
    #startBtn:active{transform:translateY(1px)}

    /* 主页面（不居中） */
    .wrap{max-width:1100px;margin:26px auto;padding:0 16px}
    h1{margin:0 0 14px;font-size:26px}
    .muted{color:var(--muted)}
    #chart{height:560px;width:100%;background:var(--card);border:1px solid #334155;border-radius:18px}
    .toolbar{display:flex;gap:10px;align-items:center;margin:8px 0 18px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #334155;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
  </style>
</head>
<body>
  <!-- 开始页 -->
  <section id="startScreen">
    <div id="brand">谁动了我的煎饼？</div>
    <button id="startBtn">START</button>
  </section>

  <!-- 主页面 -->
  <main class="wrap" id="main" style="display:none">
    <h1>谁动了我的煎饼？ · 运单状态占比</h1>
    <div class="muted" style="margin-bottom:8px">上传 .xlsx 文件，系统将自动读取所有工作表中的“运单状态”并生成圆饼图。</div>

    <div class="toolbar">
      <button id="uploadBtn" class="btn">重新上传 .xlsx</button>
      <button id="savePng" class="btn" disabled>下载图像 PNG</button>
      <span id="summary" class="muted" style="margin-left:6px">尚未载入数据</span>
    </div>

    <div id="chart"></div>
  </main>

  <!-- 隐藏文件选择器：仅 .xlsx -->
  <input type="file" id="fileInput" accept=".xlsx" style="display:none"/>

<script>
  const startScreen = document.getElementById('startScreen');
  const startBtn    = document.getElementById('startBtn');
  const main        = document.getElementById('main');
  const uploadBtn   = document.getElementById('uploadBtn');
  const fileInput   = document.getElementById('fileInput');
  const saveBtn     = document.getElementById('savePng');
  const summaryEl   = document.getElementById('summary');
  const chart       = echarts.init(document.getElementById('chart'));

  // 开始/重新上传
  startBtn.addEventListener('click', () => { fileInput.value=''; fileInput.click(); });
  uploadBtn.addEventListener('click', () => { fileInput.value=''; fileInput.click(); });

  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    if(!f.name.toLowerCase().endsWith('.xlsx')){ alert('只支持 .xlsx 文件'); return; }
    try{
      await loadWorkbook(f);
      startScreen.style.display = 'none';
      main.style.display = 'block';
    }catch(err){
      alert(err.message || '解析失败，请检查文件格式');
    }
  });

  // —— 稳读取：遍历所有 sheet，定位“最密集”的【运单状态】列并合并统计 —— //
  function norm(s){ // 统一清洗字符串：去空白/零宽并小写
    return String(s ?? '').replace(/[\s\u00A0\u200B-\u200D\uFEFF]/g,'').toLowerCase();
  }

  // 从 headerRow+1 向下扫描该列，返回 {count, freq}
  function scanColumn(sheet, colIdx, headerRow, range){
    const freq = new Map();
    let count = 0;
    let emptyStreak = 0;
    const ALLOW_EMPTY_STREAK = 15; // 连续空 15 行后提前结束（视为无更多数据）

    for(let r = headerRow + 1; r <= range.e.r; r++){
      const addr = XLSX.utils.encode_cell({r, c: colIdx});
      const cell = sheet[addr];
      let v = cell ? (cell.w ?? cell.v) : '';
      v = String(v ?? '').trim();

      if(v){
        count++;
        emptyStreak = 0;
        freq.set(v, (freq.get(v) || 0) + 1);
      }else{
        emptyStreak++;
        if(emptyStreak >= ALLOW_EMPTY_STREAK && count > 0) break;
      }
    }
    return { count, freq };
  }

  async function loadWorkbook(file){
    summaryEl.textContent = '正在解析整个表...';
    saveBtn.disabled = true;

    const buf = await file.arrayBuffer();
    const wb  = XLSX.read(buf, { type:'array' });

    const TOTAL = new Map();
    let totalRows = 0;
    const target = norm('运单状态');

    for(const sheetName of wb.SheetNames){
      const sheet = wb.Sheets[sheetName];
      if(!sheet || !sheet['!ref']) continue;

      const range = XLSX.utils.decode_range(sheet['!ref']);

      // 1) 找到所有“运单状态”候选表头
      const headers = [];
      const maxScanRows = Math.min(range.e.r, range.s.r + 80);
      for(let r = range.s.r; r <= maxScanRows; r++){
        for(let c = range.s.c; c <= range.e.c; c++){
          const cell = sheet[XLSX.utils.encode_cell({r,c})];
          if(!cell) continue;
          const v = norm(cell.w ?? cell.v);
          if(v === target) headers.push({r, c});
        }
      }
      if(headers.length === 0) continue;

      // 2) 对每个候选测“密度”，选择非空最多的那列作为本表的有效列
      let best = { count: -1, freq: null, r: -1, c: -1 };
      for(const h of headers){
        const res = scanColumn(sheet, h.c, h.r, range);
        const better = res.count > best.count ||
                      (res.count === best.count && (h.r > best.r || (h.r === best.r && h.c > best.c)));
        if(better) best = { ...res, r: h.r, c: h.c };
      }
      if(best.count <= 0) continue;

      // 3) 合并到总汇总
      totalRows += best.count;
      for(const [k,v] of best.freq.entries()){
        TOTAL.set(k, (TOTAL.get(k) || 0) + v);
      }
    }

    if(totalRows === 0){
      summaryEl.textContent = '未读取到任何“运单状态”数据';
      chart.clear(); return;
    }

    const data = Array.from(TOTAL.entries())
      .map(([name,value]) => ({name,value}))
      .sort((a,b)=> b.value - a.value);

    summaryEl.innerHTML = `共 <b>${totalRows}</b> 条记录，状态种类 <b>${TOTAL.size}</b>。`;
    drawPie(data);
    saveBtn.disabled = false;
  }

  function drawPie(data){
    chart.setOption({
      backgroundColor: 'transparent',
      tooltip: { trigger: 'item', formatter: p => `${p.marker}${p.name}<br/>数量：${p.value}<br/>占比：${p.percent}%` },
      legend: { type:'scroll', orient:'vertical', left:10, top:20, bottom:20, textStyle:{color:'#cbd5e1'} },
      series: [{
        name: '运单状态',
        type: 'pie',
        radius: ['32%','72%'],
        center: ['62%','52%'],
        itemStyle: { borderColor:'#0f172a', borderWidth:2 },
        label: { color:'#e5e7eb', formatter:'{b}  {d}%'},
        data
      }]
    }, true);
  }

  // 下载 PNG
  saveBtn.addEventListener('click', ()=>{
    const url = chart.getDataURL({ type:'png', pixelRatio:2, backgroundColor:'#0f172a' });
    const a = document.createElement('a');
    a.href = url;
    a.download = '谁动了我的煎饼-运单状态占比.png';
    a.click();
  });

  // 自适应
  window.addEventListener('resize', ()=> chart.resize());
</script>
</body>
</html>
