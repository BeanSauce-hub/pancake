<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>pancake</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#ef4444}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"PingFang SC",Segoe UI,Roboto}

  #start{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);z-index:10}
  #startBtn{font-size:40px;font-weight:800;padding:18px 64px;border:0;border-radius:18px;background:var(--accent);color:#fff;cursor:pointer}

  .wrap{min-height:100vh;display:grid;grid-template-rows:auto auto 1fr;gap:14px;place-items:center;padding:20px}
  #titlebar{font-size:28px;font-weight:800;letter-spacing:.5px;text-align:center;margin-top:10px}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:center}
  .btn,select{border:1px solid #334155;background:#1f2937;color:#e5e7eb;border-radius:10px;padding:6px 12px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .badge{color:var(--muted);font-size:12px;padding-left:6px}

  #stage{width:min(1400px,94vw);height:calc(88vh - 130px);display:flex;align-items:center;justify-content:center}
  #chart{width:100%;height:100%;background:var(--card);border:1px solid #334155;border-radius:16px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>

<section id="start"><button id="startBtn">START</button></section>

<main class="wrap" id="main" style="display:none">
  <div id="titlebar"></div>

  <div class="toolbar">
    <button id="upload" class="btn">上传 .xlsx</button>
    <select id="selector" title="派送方"></select>
    <button id="save" class="btn" disabled>下载 PNG</button>
    <span id="badge" class="badge"></span>
  </div>

  <div id="stage"><div id="chart" role="img" aria-label="运单状态占比图"></div></div>
</main>

<input type="file" id="file" accept=".xlsx" class="sr-only"/>

<script>
  const start = document.getElementById('start');
  const startBtn = document.getElementById('startBtn');
  const main = document.getElementById('main');
  const fileEl = document.getElementById('file');
  const upload = document.getElementById('upload');
  const save = document.getElementById('save');
  const badge = document.getElementById('badge');
  const selector = document.getElementById('selector');
  const titlebar = document.getElementById('titlebar');

  let chart = null, resizeObs = null;
  function ensureChart(){
    if(!chart){
      const el = document.getElementById('chart');
      chart = echarts.init(el);
      resizeObs = new ResizeObserver(()=> chart && chart.resize());
      resizeObs.observe(el);
      window.addEventListener('resize', ()=> chart && chart.resize());
    }
  }

  let GROUP = new Map(); // {派送方 -> Map(状态 -> 数量)}

  const openPicker = ()=>{ fileEl.value=''; fileEl.click(); };
  startBtn.onclick = openPicker;
  upload.onclick   = openPicker;
  selector.onchange = ()=> renderByGroup(selector.value);

  fileEl.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    if(!f.name.toLowerCase().endsWith('.xlsx')){ alert('只支持 .xlsx'); return; }
    await loadWorkbook(f);
    start.style.display='none';
    main.style.display='grid';
    ensureChart();
    requestAnimationFrame(()=> chart && chart.resize());
  });

  const norm = s => String(s ?? '').replace(/[\s\u00A0\u200B-\u200D\uFEFF]/g,'').toLowerCase();
  const fmt  = n => Number(n).toLocaleString('en-US');

  function findHeaderCandidates(sheet, range, headerText, scanRows=80){
    const target = norm(headerText), heads=[], R=Math.min(range.e.r, range.s.r+scanRows);
    for(let r=range.s.r;r<=R;r++){
      for(let c=range.s.c;c<=range.e.c;c++){
        const cell = sheet[XLSX.utils.encode_cell({r,c})];
        if(cell && norm(cell.w ?? cell.v) === target) heads.push({r,c});
      }
    }
    return heads;
  }

  function scorePair(sheet, range, headA, headB){
    const startRow = Math.max(headA.r, headB.r) + 1;
    const freqByGroup = new Map();
    let pairCount = 0, emptyStreak = 0, LIMIT = 20;
    for(let r=startRow; r<=range.e.r; r++){
      const ca = sheet[XLSX.utils.encode_cell({r, c: headA.c})];
      const cb = sheet[XLSX.utils.encode_cell({r, c: headB.c})];
      let ga = ca ? (ca.w ?? ca.v) : '';
      let sb = cb ? (cb.w ?? cb.v) : '';
      ga = String(ga ?? '').trim(); sb = String(sb ?? '').trim();
      if(ga && sb){
        pairCount++; emptyStreak = 0;
        if(!freqByGroup.has(ga)) freqByGroup.set(ga, new Map());
        const m = freqByGroup.get(ga);
        m.set(sb, (m.get(sb)||0) + 1);
      }else{
        emptyStreak++;
        if(emptyStreak >= LIMIT && pairCount > 0) break;
      }
    }
    return { pairCount, freqByGroup };
  }

  async function loadWorkbook(file){
    save.disabled = true; badge.textContent = ''; GROUP = new Map();
    const buf = await file.arrayBuffer();
    const wb  = XLSX.read(buf,{type:'array'});
    let totalRows = 0;

    for(const sheetName of wb.SheetNames){
      const sheet = wb.Sheets[sheetName];
      if(!sheet || !sheet['!ref']) continue;
      const range = XLSX.utils.decode_range(sheet['!ref']);

      const hDispatch = findHeaderCandidates(sheet, range, '派送方');
      const hStatus   = findHeaderCandidates(sheet, range, '运单状态');
      if(hDispatch.length===0 || hStatus.length===0) continue;

      let best = { pairCount: -1, freqByGroup: null };
      for(const ha of hDispatch){
        for(const hb of hStatus){
          const res = scorePair(sheet, range, ha, hb);
          if(res.pairCount > best.pairCount) best = res;
        }
      }
      if(best.pairCount <= 0) continue;

      totalRows += best.pairCount;
      for(const [dispatch, inner] of best.freqByGroup.entries()){
        if(!GROUP.has(dispatch)) GROUP.set(dispatch, new Map());
        const g = GROUP.get(dispatch);
        for(const [status, n] of inner.entries()) g.set(status, (g.get(status)||0) + n);
      }
    }

    if(totalRows===0){
      if(chart){ chart.clear(); }
      selector.innerHTML=''; badge.textContent='无数据'; titlebar.textContent='';
      return;
    }

    const options = Array.from(GROUP.keys()).sort((a,b)=>a.localeCompare(b,'zh'));
    selector.innerHTML = options.map(v=>`<option value="${encodeURIComponent(v)}">${v}</option>`).join('');
    badge.textContent = `总计 ${fmt(totalRows)}`;
    renderByGroup(encodeURIComponent(options[0]));
    save.disabled = false;
  }

  function updateTitleBar(groupName, map){
    const total = Array.from(map.values()).reduce((a,b)=> a + b, 0);
    const PICK_STATUS = new Set(['快递员收件','派送异常','签收'].map(s => norm(s)));
    let pick = 0;
    for (const [k, v] of map.entries()) if (PICK_STATUS.has(norm(k))) pick += v;
    const rate = total ? (pick / total) : 0;
    const suffix = groupName.split('-').pop() || groupName;
    titlebar.textContent =
      `${groupName} · 实际取件量 ${fmt(pick)} ｜ 应派件量 ${fmt(total)} ｜ ${suffix}取件率 ${(rate*100).toFixed(2)}%`;
  }

  function renderByGroup(encodedKey){
    ensureChart();
    const key = decodeURIComponent(encodedKey);
    const m = GROUP.get(key) || new Map();
    const data = Array.from(m.entries()).map(([name,value])=>({name,value})).sort((a,b)=>b.value-a.value);
    updateTitleBar(key, m);

    chart.setOption({
      backgroundColor:'transparent',
      tooltip:{
        trigger:'item',
        formatter:p=>`${p.name}  ${fmt(p.value)}｜${p.percent.toFixed(2)}%`
      },
      legend:{
        type:'scroll', orient:'vertical', left:'4%', top:'center',
        textStyle:{color:'#cbd5e1'}
      },
      series:[{
        name:key,
        type:'pie',
        radius: ['52%','86%'],
        center: ['60%','54%'],
        minAngle: 1.2,
        padAngle: 0,                // 无缝专业
        avoidLabelOverlap: false,
        itemStyle:{borderColor:'#0f172a',borderWidth:2},
        label:{
          show:true,
          alignTo:'labelLine',
          distanceToLabelLine: 4,
          formatter: p => `{n|${p.name}} {v|${p.percent.toFixed(1)}%}`,
          rich:{
            n:{ color:'#e5e7eb', fontSize:12, lineHeight:18 },
            v:{ color:'#e5e7eb', fontSize:12, fontWeight:700, lineHeight:18 }
          }
        },
        labelLine:{
          show:true,
          smooth:true,
          length: 12,
          length2: 14,
          minTurnAngle: 70
        },
        labelLayout: params => {
          const isLeft = params.labelRect.x < chart.getWidth()/2;
          const pts = params.labelLinePoints;
          pts[2][0] = isLeft
            ? params.labelRect.x - 6
            : params.labelRect.x + params.labelRect.width + 6;
          return { moveOverlap:'shiftY', labelLinePoints: pts };
        },
        emphasis:{ scale:false },
        data
      }]
    }, true);

    requestAnimationFrame(()=> chart.resize());
  }

  save.onclick = ()=>{
    const current = selector.options[selector.selectedIndex]?.text || 'chart';
    const url = chart.getDataURL({type:'png',pixelRatio:2,backgroundColor:'#0f172a'});
    const a = document.createElement('a'); a.href = url; a.download = `${current}-pie.png`; a.click();
  };
</script>
</body>
</html>
