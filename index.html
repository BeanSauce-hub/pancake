<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>谁动了我的煎饼？</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#ef4444}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"PingFang SC",Segoe UI,Roboto}
  /* 开场，仅按钮 */
  #start{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);z-index:10}
  #startBtn{font-size:40px;font-weight:800;padding:18px 64px;border:0;border-radius:18px;background:var(--accent);color:#fff;cursor:pointer}
  /* 主体：居中栅格 */
  .wrap{min-height:100vh;display:grid;grid-template-rows:auto auto 1fr;gap:10px;place-items:center;padding:20px}
  h1{margin:0;font-size:22px;font-weight:700;letter-spacing:.5px}
  .bar{display:flex;gap:8px;align-items:center;justify-content:center}
  .btn{border:1px solid #334155;background:#1f2937;color:#e5e7eb;border-radius:10px;padding:6px 10px;cursor:pointer}
  .badge{color:var(--muted);font-size:12px}
  #stage{width:min(1200px,92vw);height:calc(84vh - 90px);display:flex;align-items:center;justify-content:center}
  #chart{width:100%;height:100%;background:var(--card);border:1px solid #334155;border-radius:16px}
  /* 去除多余占位 */
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>

<!-- 开场 -->
<section id="start">
  <button id="startBtn">START</button>
</section>

<!-- 主体 -->
<main class="wrap" id="main" style="display:none">
  <h1>谁动了我的煎饼？</h1>
  <div class="bar">
    <button id="upload" class="btn">上传 .xlsx</button>
    <button id="save"   class="btn" disabled>下载 PNG</button>
    <span id="badge" class="badge"></span>
  </div>
  <div id="stage"><div id="chart" role="img" aria-label="运单状态占比图"></div></div>
</main>

<input type="file" id="file" accept=".xlsx" class="sr-only"/>

<script>
  // 元素
  const start  = document.getElementById('start');
  const startBtn = document.getElementById('startBtn');
  const main   = document.getElementById('main');
  const fileEl = document.getElementById('file');
  const upload = document.getElementById('upload');
  const save   = document.getElementById('save');
  const badge  = document.getElementById('badge');
  const chart  = echarts.init(document.getElementById('chart'));

  // 极简交互
  const openPicker = ()=>{ fileEl.value=''; fileEl.click(); };
  startBtn.onclick = openPicker;
  upload.onclick   = openPicker;

  fileEl.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    if(!f.name.toLowerCase().endsWith('.xlsx')){ alert('只支持 .xlsx'); return; }
    await loadWorkbook(f);
    start.style.display='none';
    main.style.display='grid';
  });

  // —— 稳健解析：遍历所有表，选取“最密集”的【运单状态】列 —— //
  const norm = s => String(s ?? '').replace(/[\s\u00A0\u200B-\u200D\uFEFF]/g,'').toLowerCase();

  function scanColumn(sheet, colIdx, headerRow, range){
    const freq = new Map(); let count=0, emptyStreak=0, LIMIT=15;
    for(let r=headerRow+1;r<=range.e.r;r++){
      const cell = sheet[XLSX.utils.encode_cell({r,c:colIdx})];
      let v = cell ? (cell.w ?? cell.v) : '';
      v = String(v ?? '').trim();
      if(v){ count++; emptyStreak=0; freq.set(v,(freq.get(v)||0)+1); }
      else { emptyStreak++; if(emptyStreak>=LIMIT && count>0) break; }
    }
    return {count,freq};
  }

  async function loadWorkbook(file){
    save.disabled = true; badge.textContent = '';
    const buf = await file.arrayBuffer();
    const wb  = XLSX.read(buf,{type:'array'});

    const TOTAL = new Map(); let totalRows = 0; const target = norm('运单状态');

    for(const name of wb.SheetNames){
      const sheet = wb.Sheets[name]; if(!sheet || !sheet['!ref']) continue;
      const range = XLSX.utils.decode_range(sheet['!ref']);

      // 找候选表头
      const heads=[]; const R = Math.min(range.e.r, range.s.r+80);
      for(let r=range.s.r;r<=R;r++){
        for(let c=range.s.c;c<=range.e.c;c++){
          const cell = sheet[XLSX.utils.encode_cell({r,c})];
          if(!cell) continue;
          if(norm(cell.w ?? cell.v)===target) heads.push({r,c});
        }
      }
      if(heads.length===0) continue;

      // 选最密集的一列
      let best={count:-1,freq:null,r:-1,c:-1};
      for(const h of heads){
        const res = scanColumn(sheet,h.c,h.r,range);
        const better = res.count>best.count || (res.count===best.count && (h.r>best.r || (h.r===best.r && h.c>best.c)));
        if(better) best={...res,r:h.r,c:h.c};
      }
      if(best.count<=0) continue;

      totalRows += best.count;
      for(const [k,v] of best.freq.entries()) TOTAL.set(k,(TOTAL.get(k)||0)+v);
    }

    if(totalRows===0){ chart.clear(); badge.textContent='无数据'; return; }

    const data = Array.from(TOTAL.entries()).map(([name,value])=>({name,value})).sort((a,b)=>b.value-a.value);
    badge.innerHTML = `总计 ${totalRows}`;
    drawPie(data);
    save.disabled = false;
  }

  function drawPie(data){
    chart.setOption({
      backgroundColor:'transparent',
      tooltip:{trigger:'item',formatter:p=>`${p.name}<br/>${p.value}｜${p.percent}%`},
      legend:{type:'scroll',orient:'vertical',left:'4%',top:'center',textStyle:{color:'#cbd5e1'}},
      series:[{
        type:'pie',
        radius: window.innerWidth<1100 ? ['42%','78%'] : ['50%','84%'],
        center:['60%','50%'],
        itemStyle:{borderColor:'#0f172a',borderWidth:2},
        label:{color:'#e5e7eb',formatter:'{b} {d}%'},
        data
      }]
    },true);
  }

  // 导出图像
  save.onclick = ()=>{
    const url = chart.getDataURL({type:'png',pixelRatio:2,backgroundColor:'#0f172a'});
    const a = document.createElement('a'); a.href=url; a.download='pancake-pie.png'; a.click();
  };

  // 自适应
  addEventListener('resize', ()=> chart.resize());
</script>
</body>
</html>
