<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>谁动了我的煎饼？</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#ef4444}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"PingFang SC",Segoe UI,Roboto}

  #start{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);z-index:10}
  #startBtn{font-size:40px;font-weight:800;padding:18px 64px;border:0;border-radius:18px;background:var(--accent);color:#fff;cursor:pointer}

  .wrap{min-height:100vh;display:grid;grid-template-rows:auto 1fr;gap:14px;place-items:center;padding:20px;position:relative}
  #titlebar{font-size:28px;font-weight:800;letter-spacing:.5px;text-align:center;margin-top:10px}

  .btn{border:1px solid #334155;background:#1f2937;color:#e5e7eb;border-radius:10px;padding:6px 12px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  #save{position:absolute;top:16px;right:24px}

  #stage{position:relative;width:min(1400px,94vw);height:calc(88vh - 120px);display:flex;align-items:center;justify-content:center}
  #chart{width:100%;height:100%;background:var(--card);border:1px solid #334155;border-radius:16px}

  /* 下拉在卡片内左上角 */
  #selector{
    position:absolute;
    top:26px;
    left:34px;
    z-index:3;
    border:1px solid #334155;background:#1f2937;color:#e5e7eb;border-radius:12px;padding:8px 14px;
    box-shadow:0 0 0 2px rgba(255,255,255,0.06) inset;
  }

  /* 右上角紧凑状态卡（自适应内容） */
  #statusCard{
    position:absolute;
    top:26px;
    right:34px;
    z-index:3;
    display:none;
    background:#0b1222;
    border:1px solid #334155;
    border-radius:14px;
    padding:12px 12px 10px 12px;
    color:#e5e7eb;
    box-shadow:0 0 0 2px rgba(255,255,255,0.03) inset;
    max-width:min(300px, 34vw);
  }
  #statusText{
    white-space:pre-line;
    font-size:16px;
    line-height:1.7;
    letter-spacing:.2px;
  }

  /* Copy 按钮在文本下方（紧凑） */
  #copyBtn{
    margin-top:10px;
    display:inline-flex;
    align-items:center;
    gap:8px;
    border:1px solid #334155;
    background:#111827;
    color:#e5e7eb;
    border-radius:10px;
    padding:8px 10px;
    cursor:pointer;
    user-select:none;
    font-weight:700;
  }
  #copyBtn:active{transform:translateY(1px)}
  #copyBtn .ico{width:18px;height:18px;display:inline-block}
  #copyBtn .ico svg{width:18px;height:18px;display:block;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
  #copyBtn.copied{background:#0f1a33;border-color:#3b82f6;color:#e5e7eb}

  /* 解析提示 */
  #hint{
    position:absolute;
    left:24px;
    bottom:18px;
    color:var(--muted);
    font-size:12px;
    display:none;
    max-width:min(900px, 92vw);
  }

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>

<section id="start"><button id="startBtn">START</button></section>

<main class="wrap" id="main" style="display:none">
  <div id="titlebar"></div>

  <button id="save" class="btn" disabled>下载 PNG</button>

  <div id="stage">
    <select id="selector" title="派送方"></select>

    <div id="statusCard" aria-label="状态汇总">
      <div id="statusText"></div>
      <button id="copyBtn" type="button" title="复制">
        <span class="ico" id="copyIco">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <rect x="9" y="9" width="13" height="13" rx="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </span>
        <span id="copyLabel">Copy</span>
      </button>
    </div>

    <div id="chart" role="img" aria-label="运单状态占比图"></div>
    <div id="hint"></div>
  </div>
</main>

<input type="file" id="file" accept=".xlsx" class="sr-only"/>

<script>
  const start = document.getElementById('start');
  const startBtn = document.getElementById('startBtn');
  const main = document.getElementById('main');
  const fileEl = document.getElementById('file');
  const save = document.getElementById('save');
  const selector = document.getElementById('selector');
  const titlebar = document.getElementById('titlebar');

  const statusCard = document.getElementById('statusCard');
  const statusText = document.getElementById('statusText');
  const copyBtn = document.getElementById('copyBtn');
  const copyLabel = document.getElementById('copyLabel');
  const copyIco = document.getElementById('copyIco');
  const hint = document.getElementById('hint');

  let chart = null, resizeObs = null;
  function ensureChart(){
    if(!chart){
      const el = document.getElementById('chart');
      chart = echarts.init(el);
      resizeObs = new ResizeObserver(()=> chart && chart.resize());
      resizeObs.observe(el);
      window.addEventListener('resize', ()=> chart && chart.resize());
    }
  }

  // { 派送方 -> Map(状态 -> 数量) }
  let GROUP = new Map();
  let statusCopyLine = '';

  selector.onchange = () => renderByGroup(selector.value);

  const openPicker = () => { fileEl.value=''; fileEl.click(); };
  startBtn.onclick = openPicker;

  fileEl.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    if(!f.name.toLowerCase().endsWith('.xlsx')){ alert('只支持 .xlsx 文件'); return; }

    hint.style.display = 'none';
    hint.textContent = '';

    try{
      await loadWorkbookStable(f);
      start.style.display='none';
      main.style.display='grid';
      ensureChart();
      requestAnimationFrame(()=> chart && chart.resize());
    }catch(err){
      console.error(err);
      hint.style.display = 'block';
      hint.textContent = '未能解析该 .xlsx。若这是系统刚下载的文件且导入为空，通常是导出结构不规范或公式未落值。建议：用 Excel 打开后 Ctrl+S 再导入，或改用“导出为值”的方式。';
    }
  });

  // utils
  const norm = s => String(s ?? '').replace(/[\s\u00A0\u200B-\u200D\uFEFF]/g,'').toLowerCase();
  const fmt  = n => Number(n||0).toLocaleString('en-US');

  // ✅ 稳定核心：二维数组解析（避免 cell.w/cell.v 扫格不稳定）
  function parseSheetToGroup(sheet){
    // 生成二维数组：每行是数组
    const rows = XLSX.utils.sheet_to_json(sheet, {
      header: 1,
      defval: '',
      blankrows: false
    });

    if(!rows || rows.length === 0) return null;

    // 找表头行：前 200 行内同时包含 “派送方” 和 “运单状态”
    const MAX_SCAN = Math.min(rows.length, 200);
    let headerRow = -1, dispatchCol = -1, statusCol = -1;

    for(let r=0; r<MAX_SCAN; r++){
      const row = rows[r] || [];
      // 建一个 norm -> colIndex 的映射（同一行可能重复，取首次）
      const idxMap = new Map();
      for(let c=0; c<row.length; c++){
        const t = norm(row[c]);
        if(t && !idxMap.has(t)) idxMap.set(t, c);
      }
      if(idxMap.has(norm('派送方')) && idxMap.has(norm('运单状态'))){
        headerRow = r;
        dispatchCol = idxMap.get(norm('派送方'));
        statusCol = idxMap.get(norm('运单状态'));
        break;
      }
    }

    if(headerRow < 0 || dispatchCol < 0 || statusCol < 0) return null;

    const freqByGroup = new Map();
    let dataCount = 0;

    // 从表头下一行开始读取
    let tailEmpty = 0;
    const TAIL_LIMIT = 300; // 末尾空白连续这么多行就停止（防止超大空表）
    for(let r=headerRow+1; r<rows.length; r++){
      const row = rows[r] || [];
      const dispatch = String(row[dispatchCol] ?? '').trim();
      const status   = String(row[statusCol] ?? '').trim();

      if(dispatch && status){
        tailEmpty = 0;
        dataCount++;
        if(!freqByGroup.has(dispatch)) freqByGroup.set(dispatch, new Map());
        const m = freqByGroup.get(dispatch);
        m.set(status, (m.get(status)||0) + 1);
      }else{
        // 如果整行几乎为空，记空尾
        const any = row.some(v => String(v ?? '').trim() !== '');
        if(!any) tailEmpty++;
        else tailEmpty = 0;

        if(tailEmpty >= TAIL_LIMIT && dataCount > 0) break;
      }
    }

    if(dataCount <= 0) return null;
    return freqByGroup;
  }

  function mergeGroup(into, from){
    for(const [dispatch, inner] of from.entries()){
      if(!into.has(dispatch)) into.set(dispatch, new Map());
      const g = into.get(dispatch);
      for(const [status, n] of inner.entries()){
        g.set(status, (g.get(status)||0) + n);
      }
    }
  }

  async function loadWorkbookStable(file){
    save.disabled = true;
    GROUP = new Map();
    statusText.textContent = '';
    statusCard.style.display = 'none';
    statusCopyLine = '';

    const buf = await file.arrayBuffer();

    // 尝试 1：raw:false + cellText:true（尽量拿到可读文本）
    let wb = XLSX.read(buf, {
      type:'array',
      raw:false,
      cellText:true,
      cellNF:false,
      cellHTML:false
    });

    let out = new Map();

    for(const sheetName of wb.SheetNames){
      const sheet = wb.Sheets[sheetName];
      if(!sheet || !sheet['!ref']) continue;
      const part = parseSheetToGroup(sheet);
      if(part) mergeGroup(out, part);
    }

    // 如果依然读不到，尝试 2：更宽松（有些文件需要 cellNF）
    if(out.size === 0){
      wb = XLSX.read(buf, {
        type:'array',
        raw:false,
        cellText:true,
        cellNF:true,
        cellHTML:false
      });
      for(const sheetName of wb.SheetNames){
        const sheet = wb.Sheets[sheetName];
        if(!sheet || !sheet['!ref']) continue;
        const part = parseSheetToGroup(sheet);
        if(part) mergeGroup(out, part);
      }
    }

    GROUP = out;

    if(GROUP.size===0){
      if(chart) chart.clear();
      selector.innerHTML='';
      titlebar.textContent='';
      statusText.textContent='';
      statusCard.style.display='none';
      save.disabled = true;

      hint.style.display = 'block';
      hint.textContent = '未从文件中找到「派送方」「运单状态」两列（可能表头不一致或文件结构异常）。';
      return;
    }

    const options = Array.from(GROUP.keys()).sort((a,b)=>a.localeCompare(b,'zh'));
    selector.innerHTML = options.map(v=>`<option value="${encodeURIComponent(v)}">${v}</option>`).join('');
    renderByGroup(encodeURIComponent(options[0]));
    save.disabled = false;
  }

  function updateTitleBar(groupName, map){
    const total = Array.from(map.values()).reduce((a,b)=> a + b, 0);
    const PICK_STATUS = new Set(['快递员收件','派送异常','签收'].map(s => norm(s)));
    let pick = 0;
    for (const [k, v] of map.entries()){
      if (PICK_STATUS.has(norm(k))) pick += (v||0);
    }
    const rate = total ? (pick / total) : 0;
    const suffix = groupName.split('-').pop() || groupName;
    titlebar.textContent =
      `${groupName} · 实际取件量 ${fmt(pick)} ｜ 应派件量 ${fmt(total)} ｜ ${suffix}取件率 ${(rate*100).toFixed(2)}%`;
  }

  function updateStatusCard(map){
    const get = (name) => {
      const target = norm(name);
      for (const [k, v] of map.entries()){
        if (norm(k) === target) return v || 0;
      }
      return 0;
    };

    const IGNORE = new Set(['快递员收件','签收','派送异常'].map(norm));
    const CLASSIFIED = new Set([
      '退回站点','集包','退回转运中心',                // DSP错分
      '上架',                                        // 外城错分
      '站点签入','转运中心签入','转运中心签出'         // 未收到
    ].map(norm));

    const dspMissort = get('退回站点') + get('退回转运中心');
    const outMissort = get('上架');
    const notReceived = get('站点签入') + get('转运中心签入') + get('转运中心签出');
    const stayHUB = get('集包');

    const lines = [];
    if(dspMissort > 0) lines.push(`DSP错分${fmt(dspMissort)}`);
    if(outMissort > 0) lines.push(`外城错分${fmt(outMissort)}`);
    if(notReceived > 0) lines.push(`未收到${fmt(notReceived)}`);
    if(notReceived > 0) lines.push(`HUB滞留${fmt(stayHUB)}`);

    for(const [name, val] of map.entries()){
      const n = norm(name);
      const v = val || 0;
      if(v <= 0) continue;
      if(IGNORE.has(n)) continue;
      if(CLASSIFIED.has(n)) continue;
      lines.push(`${name}${fmt(v)}`);
    }

    if(lines.length === 0){
      statusText.textContent = '';
      statusCard.style.display = 'none';
      statusCopyLine = '';
      return;
    }

    statusText.textContent = lines.join('\n');
    statusCopyLine = lines.join(', ');
    statusCard.style.display = 'block';
  }

  function renderByGroup(encodedKey){
    ensureChart();
    const key = decodeURIComponent(encodedKey);
    const m = GROUP.get(key) || new Map();

    updateTitleBar(key, m);
    updateStatusCard(m);

    const data = Array.from(m.entries())
      .map(([name,value])=>({name,value}))
      .sort((a,b)=>b.value-a.value);

    chart.setOption({
      backgroundColor:'transparent',
      tooltip:{trigger:'item',formatter:p=>`${p.name}  ${fmt(p.value)}｜${p.percent}%`},
      legend:{type:'scroll',orient:'vertical',left:'4%',top:'center',textStyle:{color:'#cbd5e1'}},
      series:[{
        name:key,
        type:'pie',
        radius: window.innerWidth<1200 ? ['46%','82%'] : ['52%','86%'],
        center:['60%','52%'],
        itemStyle:{borderColor:'#0f172a',borderWidth:2},
        label:{color:'#e5e7eb',formatter:(p)=>`${p.name} ${p.percent}%`},
        data
      }]
    }, true);

    requestAnimationFrame(()=> chart && chart.resize());
  }

  save.onclick = ()=>{
    if(!chart) return;
    const current = selector.options[selector.selectedIndex]?.text || 'chart';
    const url = chart.getDataURL({type:'png',pixelRatio:2,backgroundColor:'#0f172a'});
    const a = document.createElement('a');
    a.href = url;
    a.download = `${current}-pie.png`;
    a.click();
  };

  // Copy：3 秒后恢复 Copy；复制内容为同一行逗号分隔
  let copyTimer = null;
  function setCopyUI(copied){
    if(copied){
      copyBtn.classList.add('copied');
      copyLabel.textContent = 'Copied';
      copyIco.innerHTML = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M20 6 9 17l-5-5"></path>
        </svg>
      `;
    }else{
      copyBtn.classList.remove('copied');
      copyLabel.textContent = 'Copy';
      copyIco.innerHTML = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="9" y="9" width="13" height="13" rx="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      `;
    }
  }

  async function copyToClipboard(text){
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
      return;
    }
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    ta.style.top = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }

  copyBtn.onclick = async ()=>{
    if(!statusCopyLine) return;
    try{
      await copyToClipboard(statusCopyLine);
      setCopyUI(true);
      clearTimeout(copyTimer);
      copyTimer = setTimeout(()=> setCopyUI(false), 3000);
    }catch(e){
      console.error(e);
    }
  };

  setCopyUI(false);
</script>
</body>
</html>
