<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>谁动了我的煎饼？</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#ef4444}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"PingFang SC",Segoe UI,Roboto}

  #start{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);z-index:10}
  #startBtn{font-size:40px;font-weight:800;padding:18px 64px;border:0;border-radius:18px;background:var(--accent);color:#fff;cursor:pointer}

  .wrap{min-height:100vh;display:grid;grid-template-rows:auto 1fr;gap:14px;place-items:center;padding:20px;position:relative}
  #titlebar{font-size:28px;font-weight:800;letter-spacing:.5px;text-align:center;margin-top:10px}

  .btn{border:1px solid #334155;background:#1f2937;color:#e5e7eb;border-radius:10px;padding:6px 12px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  #save{position:absolute;top:16px;right:24px;z-index:5}

  #stage{
    position:relative;
    width:min(1400px,94vw);
    height:calc(88vh - 120px);
    display:flex;
    align-items:center;
    justify-content:center;
  }

  #chart{
    width:100%;
    height:100%;
    background:var(--card);
    border:1px solid #334155;
    border-radius:16px
  }

  /* 派送方下拉 */
  #selector{
    position:absolute;
    top:26px;
    left:34px;
    z-index:3;
    border:1px solid #334155;
    background:#1f2937;
    color:#e5e7eb;
    border-radius:12px;
    padding:8px 14px;
    box-shadow:0 0 0 2px rgba(255,255,255,0.06) inset;
  }

  /* ✅ 右上角文本框（新位置） */
  #statusBox{
    position:absolute;
    top:26px;
    right:34px;
    width:320px;
    min-height:110px;
    z-index:3;
    background:#0b1222;
    border:1px solid #334155;
    border-radius:14px;
    padding:14px 16px;
    color:#e5e7eb;
    font-size:16px;
    line-height:1.7;
    letter-spacing:.2px;
    box-shadow:0 0 0 2px rgba(255,255,255,0.03) inset;
    white-space:pre-line;
  }

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>

<section id="start"><button id="startBtn">START</button></section>

<main class="wrap" id="main" style="display:none">
  <div id="titlebar"></div>
  <button id="save" class="btn" disabled>下载 PNG</button>

  <div id="stage">
    <select id="selector"></select>
    <div id="statusBox"></div>
    <div id="chart"></div>
  </div>
</main>

<input type="file" id="file" accept=".xlsx" class="sr-only"/>

<script>
  const start = document.getElementById('start');
  const startBtn = document.getElementById('startBtn');
  const main = document.getElementById('main');
  const fileEl = document.getElementById('file');
  const save = document.getElementById('save');
  const selector = document.getElementById('selector');
  const titlebar = document.getElementById('titlebar');
  const statusBox = document.getElementById('statusBox');

  let chart = null;
  function ensureChart(){
    if(!chart){
      chart = echarts.init(document.getElementById('chart'));
      new ResizeObserver(()=>chart.resize()).observe(document.getElementById('chart'));
      window.addEventListener('resize',()=>chart.resize());
    }
  }

  let GROUP = new Map();
  selector.onchange = () => renderByGroup(selector.value);

  startBtn.onclick = ()=>{ fileEl.value=''; fileEl.click(); };
  fileEl.onchange = async e=>{
    const f = e.target.files?.[0];
    if(!f) return;
    await loadWorkbook(f);
    start.style.display='none';
    main.style.display='grid';
    ensureChart();
  };

  const norm=s=>String(s??'').replace(/\s/g,'').toLowerCase();
  const fmt=n=>n.toLocaleString('en-US');

  async function loadWorkbook(file){
    GROUP.clear();
    const wb = XLSX.read(await file.arrayBuffer(),{type:'array'});
    for(const s of wb.SheetNames){
      const sh=wb.Sheets[s];
      if(!sh||!sh['!ref']) continue;
      const r=XLSX.utils.decode_range(sh['!ref']);
      for(let i=r.s.r+1;i<=r.e.r;i++){
        const dsp=sh[XLSX.utils.encode_cell({r:i,c:0})]?.w;
        const st =sh[XLSX.utils.encode_cell({r:i,c:1})]?.w;
        if(!dsp||!st) continue;
        if(!GROUP.has(dsp)) GROUP.set(dsp,new Map());
        const m=GROUP.get(dsp);
        m.set(st,(m.get(st)||0)+1);
      }
    }
    const keys=[...GROUP.keys()].sort();
    selector.innerHTML=keys.map(k=>`<option value="${encodeURIComponent(k)}">${k}</option>`).join('');
    renderByGroup(encodeURIComponent(keys[0]));
    save.disabled=false;
  }

  function updateTitleBar(k,m){
    let total=0,pick=0;
    const PICK=new Set(['快递员收件','签收','派送异常'].map(norm));
    for(const [n,v] of m){ total+=v; if(PICK.has(norm(n))) pick+=v; }
    const rate=total?pick/total:0;
    const suf=k.split('-').pop();
    titlebar.textContent=
      `${k} · 实际取件量 ${fmt(pick)} ｜ 应派件量 ${fmt(total)} ｜ ${suf}取件率 ${(rate*100).toFixed(2)}%`;
  }

  function updateStatusBox(m){
    const get=n=>[...m].find(([k])=>norm(k)===norm(n))?.[1]||0;
    const lines=[];
    const dsp=get('退回站点')+get('集包')+get('退回转运中心');
    const out=get('上架');
    const nr =get('站点签入');
    if(dsp>0) lines.push(`DSP错分${fmt(dsp)}`);
    if(out>0) lines.push(`外城错分${fmt(out)}`);
    if(nr>0)  lines.push(`未收到${fmt(nr)}`);
    statusBox.textContent=lines.join('\n');
  }

  function renderByGroup(v){
    const k=decodeURIComponent(v);
    const m=GROUP.get(k);
    updateTitleBar(k,m);
    updateStatusBox(m);
    ensureChart();
    chart.setOption({
      tooltip:{trigger:'item'},
      legend:{left:'4%',top:'center',textStyle:{color:'#cbd5e1'}},
      series:[{type:'pie',radius:['52%','86%'],center:['60%','52%'],
        data:[...m].map(([n,v])=>({name:n,value:v}))}]
    });
  }

  save.onclick=()=>{
    const url=chart.getDataURL({type:'png',pixelRatio:2,backgroundColor:'#0f172a'});
    const a=document.createElement('a');
    a.href=url;a.download='chart.png';a.click();
  };
</script>
</body>
</html>
